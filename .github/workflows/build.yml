name: Graphhopper Build & Mutation

on: push

permissions:
  contents: write   

jobs:
  compile-and-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-ver: [ 24, 25-ea ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java ${{ matrix.java-ver }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-ver }}
          distribution: temurin

     
      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

     
      - name: Cache web node folder
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pom.xml','**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

     
      - name: Build & run tests
        id: standard-build
        run: mvn -B clean install
        continue-on-error: true

     
      - name: Surprise Rickroll!
        if: steps.standard-build.outcome == 'failure'
        run: |
          echo "ðŸš¨ Build failed! Don't panic, but check this out..."
          echo "ðŸŽµ A totally different Rickroll incoming ðŸŽµ"
          echo "ðŸ‘‰ https://www.youtube.com/watch?v=dQw4w9WgXcQ&ab_channel=RickAstley"
          echo "::error::Remember: it's just code, have fun! ðŸ˜Ž"
          exit 1

      - name: Run mutation analysis and update baseline
        if: |
          success() &&
          matrix.java-ver == '24' &&
          github.event_name == 'push' &&
          github.ref == 'refs/heads/master'
        run: |
          echo "Starting mutation testing..."

          
          MUTATION_BASE="pitest-baseline.txt"
          if [ ! -f "$MUTATION_BASE" ]; then
            echo "0" > "$MUTATION_BASE"
          fi

          PREV_SCORE=$(cat "$MUTATION_BASE" | tr -d '\n' | tr -d '\r')
          echo "Previous mutation threshold: ${PREV_SCORE}%"

          # Run PIT on core module with threshold
          mvn -B -pl core org.pitest:pitest-maven:mutationCoverage -DmutationThreshold=$PREV_SCORE | tee pitest_run.log
          PIT_STATUS=${PIPESTATUS[0]}

          if [ $PIT_STATUS -ne 0 ]; then
            echo "::error::Mutation score below threshold or PIT failed."
            exit $PIT_STATUS
          fi

          # Extract new mutation score
          SCORE_LINE=$(grep "Generated .* mutations Killed" pitest_run.log || true)
          if [ -z "$SCORE_LINE" ]; then
            echo "::error::Could not find mutation summary line."
            exit 1
          fi

          CUR_SCORE=$(echo "$SCORE_LINE" | sed -E 's/.* \(([0-9]+)%\).*/\1/')

          echo "Previous threshold: ${PREV_SCORE}%"
          echo "Current mutation score: ${CUR_SCORE}%"

          # Update baseline if improved
          if [ "$CUR_SCORE" -gt "$PREV_SCORE" ]; then
            echo "ðŸŽ‰ Mutation score improved! Updating baseline..."

            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'

            echo "$CUR_SCORE" > "$MUTATION_BASE"
            git add "$MUTATION_BASE"
            git commit -m "ci: auto-update mutation baseline to ${CUR_SCORE}%"
            git pull --rebase origin master
            git push origin HEAD:master
          else
            echo "No improvement. Baseline remains at ${PREV_SCORE}%."
          fi
