name: Mutation Testing & Rickroll

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  mutation-test:
    name: PIT Mutation Tests
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        java: [ '24', '25-ea' ]

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up Java version
      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}

      # Run pitest
      - name: Run Mutation Tests
        run: mvn -B org.pitest:pitest-maven:mutationCoverage

      # Extract mutation score from XML output
      - name: Extract mutation score
        id: score
        run: |
          REPORT_FILE=target/pit-reports/*/mutations.xml
          SCORE=$(grep -oP 'mutationScore="\K[0-9.]+' $REPORT_FILE | head -n 1)
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "Mutation score: $SCORE"

      # Load baseline (or create if not found)
      - name: Load baseline
        id: baseline
        run: |
          if [ -f .mutation-baseline ]; then
            BASELINE=$(cat .mutation-baseline)
          else
            BASELINE=0
          fi
          echo "baseline=$BASELINE" >> $GITHUB_OUTPUT
          echo "Baseline: $BASELINE"

      # Fail if score worse than baseline
      - name: Compare to baseline
        id: compare
        run: |
          SCORE=${{ steps.score.outputs.score }}
          BASELINE=${{ steps.baseline.outputs.baseline }}

          # Fail if current score < baseline
          awk -v s="$SCORE" -v b="$BASELINE" 'BEGIN { exit !(s < b) }'
        continue-on-error: true

      # Rickroll if mutation score is worse
      - name: Rickroll
        if: steps.compare.outcome == 'success'
        uses: TheDrizzyWay/random-rickroll@main

      # If score is better or equal â†’ update baseline automatically
      - name: Update baseline
        if: steps.compare.outcome != 'success'
        run: |
          echo "${{ steps.score.outputs.score }}" > .mutation-baseline
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .mutation-baseline
          git commit -m "Auto-update mutation baseline to ${{ steps.score.outputs.score }}"
          git push

